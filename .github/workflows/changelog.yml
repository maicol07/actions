name: Build changelog
on:
  workflow_call:
    inputs:
      next_version:
        description: 'Next version tag to use instead of UNRELEASED. If not entered it will be fetched from the commits.'
        type: string
        required: false

      config_dir:
        description: 'git-chglog configuration directory'
        default: '.chglog'
        type: string
        required: false

      filename:
        description: 'Filename to write the changelog to'
        default: 'CHANGELOG.md'
        type: string
        required: false

      path:
        description: 'Optional path to follow for directory'
        default: ''
        type: string
        required: false

      tag_query:
        description: 'Optional tag query to use for changelog generation'
        default: ''
        type: string
        required: false

      commit_message:
        type: string
        description: "Commit message"
        required: false

jobs:
  generate_changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: recursive
      - name: Pull changes
        run: git pull
      - uses: maicol07/github-changelog-action@master
        with:
          config_dir: ${{ github.event.inputs.config_dir }}
          filename: ${{ github.event.inputs.filename }}
          path: ${{ github.event.inputs.path }}
          tag_query: ${{ github.event.inputs.tag_query }}
          next_version: ${{ github.event.inputs.next_version }}
      - uses: oleksiyrudenko/gha-git-credentials@v2-latest
        with:
          token: '${{ secrets.GITHUB_TOKEN }}'
      - name: Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v4
        if: ${{ !github.event.inputs.commit_message }}
        with:
          commit_message: "changelog: üìù Updated changelog for ${{ github.event.inputs.next_version && 'release' || 'commit' }} ${{ github.event.inputs.next_version && github.event.inputs.next_version || github.sha }}"
          file_pattern: 'CHANGELOG.md'
      - uses: stefanzweifel/git-auto-commit-action@v4
        if: ${{ github.event.inputs.commit_message }}
        with:
          commit_message: ${{ github.event.inputs.commit_message }}
          file_pattern: 'CHANGELOG.md'
